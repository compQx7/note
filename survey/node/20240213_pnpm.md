# pnpmについて

## 仕組み

- node_modulesに存在する全てのパッケージに含まれるそれぞれのファイルは、コンテンツストアへのハードリンク
- 新たに依存関係が増えても依存関係のグラフ構造は深くなるが (foo > bar > qar) 、ファイルシステム上のディレクトリ階層の深さは元のまま。

1. pnpmはnode_modules（.pnpm）にそれぞれのパッケージ（パッケージが依存するパッケージも含む）の（storeへの）ハードリンクを作成します。
    node_modules
    └── .pnpm
        ├── bar@1.0.0
        │   └── node_modules
        │       └── bar -> `<store>`/bar
        │           ├── index.js
        │           └── package.json
        └── foo@1.0.0
            └── node_modules
                └── foo -> `<store>`/foo
                    ├── index.js
                    └── package.json
2. 依存関係同士をシンボリックリンクで結びつける。
    node_modules
    └── .pnpm
        ├── bar@1.0.0
        │   └── node_modules
        │       └── bar -> `<store>`/bar
        └── foo@1.0.0
            └── node_modules
                ├── foo -> `<store>`/foo
                └── bar -> ../../bar@1.0.0/node_modules/bar
3. 直接的な依存関係を処理します。 fooはプロジェクトの依存関係になっているので、シンボリックリンクを最上位のnode_modulesに作成します。
    node_modules
    ├── foo -> ./.pnpm/foo@1.0.0/node_modules/foo
    └── .pnpm

## 移行

1. 環境ごとのNodeバージョンに応じたpnpmを利用するため、npmコマンドでpnpmをインストールします。

    ```sh
    npm install -g pnpm
    ```

2. `src/ui/`以下にあるすべての`node_modules`と`package-lock.json`を削除します。

3. `src/ui/`に`pnpm-workspace.yaml`を配置します。

    ```yaml
    packages:
      - 'applications/**'
      - 'packages/**'
      - 'scripts/**'
    ```

4. `src/ui/`で```pnpm install```を実行します。

> 参考: [pnpmのアンインストール](https://pnpm.io/ja/uninstall)

## 重要な概念

### パッケージストア

ストアのパスを確認
pnpm store path
[package storeの場所](https://pnpm.io/ja/npmrc#store-dir)

下記コマンドを実行した場合、`<path>/v3` で管理されるようになります。

```sh
pnpm config set store-dir <path>
```

### workspace

子パッケージの依存を含めたすべての依存の 実体 はワークスペースのルートのバーチャルストア (node_modules/.pnpm/) に集約され、そこからシンボリックリンクが子パッケージの node_modules/ 内に貼られます。

npm workspace を利用するには npm のバージョン 7 以降が必要です。

- pnpm-workspace.yaml

```yaml
packages:
  - 'applications/**'
  - 'packages/**'
  - 'scripts/**'
```

ワークスペースになる条件
pnpm-workspace.yaml を設置することです。

デフォルトでrolling
[save-workspace-protocol](https://pnpm.io/ja/npmrc#save-workspace-protocol)

ワークスペース内で依存関係を定義するには ワークスペースプロトコル (workspace:) を使用します。
package.json に "@my-org/my-package": "workspace:*" と書くと同名の子パッケージを依存として加えます。 node_modules/ 内から対象へ直接シンボリックリンクが張られます。
"foo": "workspace:../foo" のように、相対パスを使うこともできます。
pnpm publish 時には、ワークスペースプロトコルを使わない形に変換されます。
[link-workspace-package](https://pnpm.io/ja/npmrc#link-workspace-packages)
[workspace protocol](https://pnpm.io/ja/workspaces#%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB-workspace)

### .npmrc

### package.json

[peer dependencyの解決](https://pnpm.io/ja/how-peers-are-resolved)

## 参考サイト

- [official](https://pnpm.io/ja)

- [いろいろまとめた記事](https://zenn.dev/luma/articles/4f763dc90fcaaa)

## 調査中

pnpm install はどこで使っても同じ効果です。
    pnpm install を行うとすべての子パッケージ内の依存をインストールします。
    子パッケージの依存を含めたすべての依存の 実体 はワークスペースのルートのバーチャルストア (node_modules/.pnpm/) に集約され、そこからシンボリックリンクが子パッケージの node_modules/ 内に貼られます。
    (細かい) バーチャルストア (.pnpm/) の中身は、前述したグローバルストアと同じものへのハードリンクです。
作業ディレクトリに依存するコマンドは --workspace-root, -w を指定することでルートから実行できます。
pnpm run ... は現在のディレクトリにある package.json を見ます。
すべてのパッケージの特定の名前のスクリプトを実行する方法はいくつかあります。
    --recursive, -r を指定する。
    (例外) "build": "pnpm run build -r" のように書くとループします。以下で対処できます。
    フィルタリング を用いる。
    pnpm run build --filter ./packages で ./packages 配下にある子パッケージ全てで実行します。
    --filter "*core" で名前 (= packge.json の .name) に core と末尾につく子パッケージを指定できます。
    (応用) さらに変更があったパッケージ、及びその依存、といった指定もできます。詳しくはドキュメントを参照してください。
ワークスペース内で依存関係を定義するには ワークスペースプロトコル (workspace:) を使用します。
    package.json に "@my-org/my-package": "workspace:*" と書くと同名の子パッケージを依存として加えます。 node_modules/ 内から対象へ直接シンボリックリンクが張られます。
    "foo": "workspace:../foo" のように、相対パスを使うこともできます。
    pnpm publish 時には、ワークスペースプロトコルを使わない形に変換されます。

誰かがnpm installやyarnを実行しても、インストールは開始せず、エラーになります。
npm v7を使用している場合、代わりにnpx -yとしてください。

```json
{
    "scripts": {
        "preinstall": "npx -y only-allow pnpm"
    }
}
```

### npmコマンドによる事故への対応方法

- 実行してしまった後にリカバリー

1. `src/ui/`以下にあるすべての`node_modules`と`package-lock.json`を削除します。
2. `src/ui/`で```pnpm install```を実行します。

- npmコマンドを実行させない

only-allow を使用する方法

```json:package.json
"preinstall": "npx -y only-allow pnpm"
```

engine-strcit 設定を true にして package.json に engines 項を記述する方法。

```yaml:.npmrc
engine-strict=true
```

```json:package.json
"engines": {
  "npm": "forbidden, use pnpm",
  "pnpm": ">=6",
  "yarn": "forbidden, use pnpm"
}
```

workspace、インターナルパッケージ、workspaceプロトコル
