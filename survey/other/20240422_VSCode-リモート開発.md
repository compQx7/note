# VSCodeによるリモート開発（RemotePC の Hyper-V）

前提: LocalPC, RemotePC, VM すべてWindows

## VMのSSHサーバー設定

- Hyper-V の VM 上で設定画面から OpenSSH をインストール
- OpenSSH サーバーの常時稼働設定

```powershell
Get-Service -Name sshd | Set-Service -StartupType Automatic
Start-Service sshd
```

- 接続確認（RemotePC -> Hyper-V）

```powershell
ssh [User(VM)]@[Host(VM)]
```

## Hyper-V内部スイッチを作成

- hyper-V内部ネットワークからホスト経由でネットワーク接続できるように設定する。

```powershell
New-VMSwitch -SwitchName [SwitchName] -SwitchType Internal
```

- InterfaceIndexを確認後、ゲートウェイのIPアドレスと紐づける。

```powershell
Get-NetAdapter
New-NetIpAddress -IpAddress 172.16.1.1 -PrefixLength 24 -InterfaceIndex [Index]
```

- NATネットワークを構成する。

```powershell
New-NetNat -Name [InternalNAT] -InternalIpInterfaceAddressPrefix 172.16.1.0/24
```

## VMのネットワーク設定

- 設定の「ネットワークとインターネット」でNATネットワークのプロパティを選択
- 手動でIPアドレス（172.16.1.*）、プレフィックス長（24）、デフォルトゲートウェイ（RemotePC）、DNSサーバー（8.8.8.8など）を設定

## RemotePCによるポートフォワーディング設定

Hyper-Vホストが代表のポート接続を受け、そのポートを対象サーバーのポートへフォワードする

- 仮想マシンを Hyper-V の内部ネットワークセグメント（172.16.1.*）へ所属させる。

```powershell
Add-NetNatStaticMapping -NatName [InternalNAT] -ExternalIpAddress "0.0.0.0" -ExternalPort [Port] -InternalIpAddress ["172.16.1.*"] -Protocol tcp -InternalPort 22
```

- ファイアウォール設定によりExternalPortに対するローカルIP（LoaclPCを指定）制限を設定する。

## LocalPCでSSH接続設定

- LocalPCで秘密鍵を生成し、VMに公開鍵を配置する。
[参考Microsoft](https://learn.microsoft.com/ja-jp/windows-server/administration/openssh/openssh_keymanagement)

```powershell
ssh-keygen -t ed25519
$authorizedKey = Get-Content -Path $env:USERPROFILE\.ssh\[id_ed25519.pub]
$remotePowershell = "powershell Add-Content -Force -Path $env:ProgramData\ssh\administrators_authorized_keys -Value '$authorizedKey';icacls.exe ""$env:ProgramData\ssh\administrators_authorized_keys"" /inheritance:r /grant ""Administrators:F"" /grant ""SYSTEM:F"""
ssh [User(VM)]@[Host()] $remotePowershell
```

- 接続確認（LocalPC -> RemotePC -> Hyper-V）

```powershell
- ssh -p [Port(RemotePC)] [User(VM)]@[Host(RemotePC)]
```

## 接続（LocalPC -> RemotePC -> Hyper-V）

- VSCodeのRemote-SSH（パスワード認証）拡張をインストール。コマンドパレットの「Remote SSH: Connect to Host」を利用する。
- ~/.ssh/configに下記を設定する。

| key | value |
| --- | --- |
| Host | 任意の接続名 |
| > HostName | ドメイン名 or RemotePCのIP=VPNのIP |
| > User | VMのUser |
| > Port | RemotePCのPort |
| > IdentifyFile | ~/.ssh/[id_ed25519] |
