
# network
* 家庭のPCがインターネットを構成するネットワークに繋がろうと思ったら、ISPと契約してISPのネットワークの一部になる。

## OSI参照基本モデル
<table>
  <tr>
    <th colspan="2">階層</th>
    <th>PDU</th>
    <th>主な機器</th>
  </tr>
  <tr>
    <td>レイヤ7</td>
    <td>アプリケーション層</td>
    <td rowspan="3">メッセージ</td>
    <td rowspan="3"></td>
  </tr>
  <tr>
    <td>レイヤ6</td>
    <td>プレゼンテーション層</td>
  </tr>
  <tr>
    <td>レイヤ5</td>
    <td>セッション層</td>
  </tr>
  <tr>
    <td>レイヤ4</td>
    <td>トランポート層</td>
    <td>セグメント</td>
   <td>ゲートウェイ</td>
  </tr>
  <tr>
    <td>レイヤ3</td>
    <td>ネットワーク層</td>
    <td>パケット</td>
   <td>ルーター</td>
  </tr>
  <tr>
    <td>レイヤ2</td>
    <td>データリンク層</td>
    <td>フレーム</td>
   <td>ブリッジ、スイッチングハブ</td>
  </tr>
  <tr>
    <td>レイヤ1</td>
    <td>物理層</td>
    <td>ビット</td>
   <td>リピーター</td>
  </tr>
</table>

* [PDU] 制御情報であるヘッダと通信データの中身であるペイロードで構成される

## リピータ
* 物理層の中継。

## ブリッジ
* データリンク層の中継。MACアドレスをもとにセグメント間を中継。

## スイッチングハブ
* MACアドレスを見て宛先を振り分ける。
* データリンク層。

## リピーターハブ
* 繋がってるみんなに送り、関係ない人には無視してもらう。
* 今ではスイッチングハブに世代交代し、あまり使われていない。

## ルーター
* ネットワーク層の中継
* ２つ以上のインターフェイスを持ち、ネットワーク同士の境界線となる。
* ルーターが扱うデータはパケット。
* ネットワークがやり取りするデータを橋渡しするのがルーター。宛先を見てホップホップバイホップで次の宛先を決める。
* [ルーティング] ネットワーク同士をレイヤー３で接続するための技術。
* [宛先の決定] ルーティングテーブルのメトリックの値が小さいインターフェイスへ送る（フォワーディング）。間違ったルーティングテーブルを持っていると宛先に届かず、ループすることもある。
* [ルーティングテーブルの更新方法] 管理者が手動で変更するスタティックルーティング。ルーター同士がルーティングプロトコルをやり取りして情報交換するダイナミックルーティング。
* [ルーティングプロトコル] ルーティングプロトコルが違うルーター同士はルーティング情報を交換できない。大きく２種類、EGPが異なる組織同士を繋ぐいわゆるインターネットのプロトコル（BGP4）。IGPが組織のネットワーク（AS）内で使われるプロトコル。
* [AS] IGPによりやり取りされるネットワーク群。家庭のルーターもISPのルーターを出入り口とするAS内の一部と言える。
* [BGP4] インターネットのルーティングプロトコルEGP。全てのネットワークへの経路を交換する。百数十万からなると言われる。高い性能を求められるため、ISPのルーターなどに限られる。
* [デフォルトルート] インターネットの出入り口となるルーターへの経路。同じネットワーク内にない宛先への経路はデフォルトルートにまとめることでルーティング情報を大幅に減らせる。0.0.0.0/0。ISP同士のASもあったりと、その時々で、デフォルトルートは変わる。どの範囲のネットワークで見て宛先を探し、なければそのネットワーク内でのインターネットへの入り口をデフォルトルートとする。
* [ルーティングテーブルの更新] 最適経路を決める評価値をメトリックと呼ぶ。IGPのRIPの場合ベルマンフォード方式でホップ数で判断し、OSPFの場合は、ダイクストラ法でコストで判断する。

## ゲートウェイ
* トランスポート層以上が異なるネットワーク間で、プロトコル変換による中継。

## スイッチ
* ルータと異なりデータ（フレーム）を中継しない。宛先以外にデータを送らないというフィルタリングをする。
* [ルーターとの違い] スイッチはフレームを流すかどうかを決めるだけでフレームに手を加えない。ルーターはパケットを送り直すため、パケットの一部を変更する。FCSやヘッダーを使用する回線の種類に合わせたり、IPヘッダーのTTLを１つ減らしたり、


# プロトコル
* プロトコルは仕様。仕様に沿って開発者は実装する。

## TCP
* [信頼性を実現する役割] 3wayハンドシェイクによるコネクションの確立、確認応答による受信確認、ウィンドウサイズによるオーバーフローの防止と効率化、スロースタートアルゴリズムによる輻輳の防止と効率化。
* [3wayハンドシェイク] 接続要求→応答と接続要求→応答。応答がなければ再送する。
* [信頼性を高める仕組み] データを分割して（このデータをセグメントと呼ぶ）、送信に失敗したセグメントをシーケンス番号をもとに再送する。ちなみにセグメントの最大サイズをMSSという。
* [通信効率を高める仕組み] バッファーに格納可能なデータ量をウィンドウサイズと言い、受信側は確認応答のたびにこれを送信する。確認応答を待たずに送信する。。送信量を少しずつ増やし、輻輳が続くことを避ける。

# Webアプリケーション
* HTMLを受け取ったブラウザはそのページを表示するために必要な画像などをwebサーバーにリクエストする。そうして揃ったデータをHTMLに基づいて画面に表示することをレンダリングという。
* Webページを構成する画像もひとつひとつWebサーバーにリクエストして受け取るため、ページが表示されるまでに数多くのやり取りが行われる。

# ドメイン
* [ドメイン誕生のポイント] 階層化と委任により、管理負担軽減、変化への柔軟な対応を可能にした。
* [DNS] ドメインからIPアドレスを取得する仕組み。
* [DNSの構成要素] スタブリゾルバー（DNSクライアント）、フルリゾルバー（キャッシュDNSサーバー）、権威サーバー。
* [スタブリゾルバー] スマホなどに搭載されており、フルリゾルバーに対して名前解決要求を出す。ブラウザやアプリケーションにAPIを提供する。
* [フルリゾルバー] 権威サーバーへ反復的に問い合わせて名前解決を行う。一度問い合わせたドメインをキャッシュする。
* [権威サーバー] 自分が委任を受けたゾーンの情報と自分が委任したゾーンの委任情報を保持する。
* [リソースレコード] 権威サーバーが保持するゾーンの設定内容。ドメイン名、タイプ、データ（IPアドレス等）などで構成される。
* あるドメインが使われているか、誰がドメインを所有しているかを調べるサービス、WHOIS
* digコマンド等を使った動作確認
* キャッシュDNSサーバーはISPや企業が設置する。


# セキュリティ
* 各ネットワークレイヤにおけるセキュリティを考える

# コマンド
ping
traceroute
telnet
nslookup
dig

Wireshark

# 基礎
## NAT
* 内部で通用するアドレスを外部と接続できるアドレスに変換する。これにより一方向の通信（リクエスト）を実現できる。

# Port Fowarding

## Local Port Fowarding
```shell
ssh -L 10080:localhost:80 192.0.2.1
ssh -L 10080:172.31.10.10:80 192.0.2.1
ssh -L [マッピングするLocalPort]:[接続先Host]:[接続先Port] [SSH接続するIP]
```
ローカルPCの10080ポートを通して、ポート80でリッスンしているリモートマシン（192.0.2.1）へ接続できる。
接続先Hostは、SSH接続するIPから見た接続先のIPアドレスを設定する。
アクセスしたい先がSSH接続先のサーバーであればlocalhostになる。自分のPC上のブラウザなどから、http://localhost:10080/ などとアクセスすることが可能になる。
Webサーバーを転送する以外にも、RDPポート（標準では3389）を転送することで、FWでSSHしか許可されていない場合にも踏み台経由でリモートデスクトップを使う、といったことが可能になる。

## Remote Port Fowarding
社内ネットワークからクラウド側に対して、外向きのSSHしか許可されていない状況下で、接続先サーバーから、社内の任意のマシンへの接続を可能にする。
```shell
ssh -R 10080:localhost:80 192.0.2.1
ssh -R 10080:192.168.1.2:80 192.0.2.1
ssh -R [LocalPortOnRemote]:[HostToConnect]:[PortToConnect] [GlobalIp]
```

クラウド上のVM1での localhost:10080 への接続は、社内のPC1の 80 へ転送されることになります(localhost:10080のlocalhostはクラウド上のVM1のこと)。ポートフォワード設定における localhost は、社内のPC1上のことを意味します。

社内のPC1から、クラウド上のVM1への外向きのSSH接続が許可されているだけで、そこを通して、外部からの接続を実現できることになり、非常に便利ですので、知っていおいて損はありません。

<local port on remote> : SSH接続先で使うポート
<host to connect> : ポート転送の接続先のホスト名またはIPアドレス ( 社内のPC1でアクセス可能なホスト名やIPアドレスであること )
<port to connect> : 接続先のポート番号
<global ip address> : SSH接続するホスト名またはIPアドレス ( 作業PCでアクセス可能なホスト名やIPアドレスであること )

# ネットワーク本（タイトル忘れた）
## ネットワーク
ネットワークを学ぶとはプロトコルを学ぶこと。
プロトコルには依存関係があり、階層の上下関係を表したのがOSI参照モデル。

通信相手の特定は大事な論点。
現在はIPアドレスによる2段階層となっている。通信する相手を大きく絞ることに寄与している。

インターネットは無数の小さなネットワークがルータによって繋がれた集合体。
どこでサブネットを区切るか。

ARPはイーサネットでつながるすべてのコンピューターに通信したいIPアドレスをブロードキャスト（そこにいる全員に通信）し、対応するMACアドレスを返信してもらう。

イーサネットでは早い者勝ちで通信を行うCSMA/CD（スイッチの普及と通信経路の全二重化により役目を終えかけている）という通信方式を利用。通信に先立ってネットワーク状態を調査するCS（キャリアセンス）、ケーブルが空いていれば先にアクセスしたノードを優先することで多数のノードを収容するMA（マルティブルアクセス）。コリジョンの可能性がある。衝突を検知したら再度送り直すCD（コリジョンディテクション）

ブリッジ（今はブリッジを組み合わせたスイッチが主流）はMACアドレスを用いてコリジョンドメインを分割する。

ルーターはIPアドレスを用いてブロードキャストドメインを分割する。
ルーターは２つのネットワークと接続するため、IPアドレス（ネットワークカード）を2つ持つ。
ルーターで分けたネットワークのネットワークアドレスを変えることを忘れない。

OSI参照モデルの考え方により、下位のネットワークがどのように作られていても上位に影響なく世界中が通信できる。

## ポート
IPの定義はノード間のエンドトゥエンドの実現。郵便が個人まで送らず英が家まで届けるのと同じで、IP通信も送信元や送り先はコンピュータのNIC単位

IPアドレスは世界中を識別する必要があるから桁数が多く、ポートはコンピュータ内のサービスを識別するだけで良いから桁数は少ない。住所と名前の関係と似ている。

自分のコンピューターがダイナミックポートとして何番を使っているかは netstatコマンドで調べられる。ESTABLISHEDは接続中の意。

ポート自体が何か処理をするわけではなく、ポートの背後にプログラムが接続されていて（プログラムにポートを割り当てるの意味）、あるポートに着信した通信はそのままポートを流れてプログラムに到達するようになっている。

ポートは送信中に受信することはできないし、同時に複数受信することもできないので、アプリによっては送信用と受信用で2つのポートを占有する場合もある。

受信側がウィンドウサイズを調整して捌ける量を通知する。

## ルーター
ルーターはあて先ネットワークのある方向のみにパケットを転送するためにルーティングテーブルを持っている。ルーターはノードではなく、ネットワークそのものに転送することだけを考える。

ルーティングテーブルにあるゲートウェイは「あて先ネットワークに至るために次に転送すべきルーター」を指す。

一般のパソコンのデフォルトゲートウェイは、最寄りのルーター、他のネットワークと通信するときに中継してくれるもの。
ルーターにとってのデフォルトゲートウェイは、中継先不明の場合に送るルーターを指す。

NATは通信を経由するルーターが持つグローバルアドレスをプライベートアドレスしか持たないコンピューターに貸し出して通信させる技術。
ルーターはコンピューターのプライベートアドレスと貸した（変換した）グローバルアドレスの対応づけを保持しておく。
ルーターが持つグローバルアドレスの数しか通信できない。それ以外のコンピューターはグローバルアドレスが空くのを待つしかない。

NAPT（IPマスカレード）はひとつのグローバルアドレスを使い回せるよう、ポート番号も含めてアドレス変換する仕組み。変換する際にTCP（UDP）ヘッダも書き換える。
プライベートアドレスAから通信を受けたコンピューターは、ヘッダの情報を読んで「グローバルアドレスXのコンピューターのポートYを使って通信してきた」と素直に解釈する。
ルーターはNAPTで変換した「プライベートアドレスA + ルーターポート番号 = グローバルアドレスX」の組み合わせを変換テーブルとして持っておく。
NAPTはセキュリティ向上にも役立つ。アドレスが変換されているので外からはルーターまでしか認識できない。その先のコンピューターの存在やアドレスを知ることはできない。ルーターそのものがクラッキングされたり、攻撃用通信をあっさりアドレス変換して通してしまえば話は別だが、怪しい通信はアドレス変換せず破棄することでセキュリティを上げられる。

## ファイアウォール
外から中へ入ってくるインバウンドトラフィックと中から外へ出て行くアウトバウンドトラフィックをフィルタリングする。
フィルタリングルールとしては登録されたもの以外は全て通すブラックリスト方式と登録されたものしか通さないホワイトリスト方式がある。
ネットワーク層の情報を扱える機器（ルーター）であれば、IPアドレスによるフィルタリングを行える。パケットフィルタリング型ファイアウォール
ルーターは元々ネットワーク層の通信機器だが、実際にはトランスポート層のポート番号情報も加味して通信制御できるものがほとんど。こういったルーターはサービス単位（ポート単位）でフィルタリングできる（トランスポートゲートウェイ型）。
アプリケーション層までチェックできるアプリケーションゲートウェイ型ファイアウォールもあるが、通信速度が遅くなったり、制御したいすべてのアプリのプロトコルに対応する必要があるなど一長一短。パケットフィルタリング型はIPヘッダを、トランスポートゲートウェイ型はIPヘッダ、TCPヘッダを、アプリケーションゲートウェイ型はIPヘッダ、TCPヘッダ、データまでを調べる。

DMZは公開サーバーを内部ネットワークに置いても危険だし、ファイアウォールの外に野ざらしにしても危険なので生まれた。実際にファイアウォールを2台用意するのは大変なので、ほとんどの製品が1台でDMZを構成できるようになっている。

## DNSとDHCP
FQDNとIRアドレスの紐付けデータベースは一般的なWindowsにも作成できる。C:/Windows/System32/drivers/etc/hosts

すべてのコンピューターの名前対応を記録するのは現実的ではないためDNSサーバーを構築するのが一般的。コンピューターにはリゾルバというDNSクライアントが入っており、これが名前解決する。パソコンのIPの基本設定ではDNSサーバーのIPを設定する（ipconfig）で確認可能。

電源を入れたPC（DHCPクライアント）がブロードキャストによってIPアドレスを要求すると、DHCPサーバーは空いているIPアドレス貸し出す。この時サブネットマスク、ゲートウェイ、ドメイン名、DNSサーバーのアドレスなども伝える。
IPアドレスのリース期限は決まっているが、PCの電源を入れ続けている場合、延長要求が出される。

ゲートウェイは物理層からアプリケーション層まで、すべてのプロトコルを知っている通信機器。

## 無線LANとWi-Fi
速度のメガはビット単位、容量のメガはバイト単位。


## クラウド
サーバーに資源を集中させるシンクライアント、クライアントにある程度の資源を配分するファットクライアント。


## メモ
ルーターに向けて通信が流れるようにする。
インターネットゲートウェイからインターネットに接続する。

## ネットワークを分割する理由・利点
* 部署ごとに分けることでセキュリティを担保したり、どちらかに障害が起きた時に影響を小さくしやすい。
* サーバー群を別サブネットに分けることで、そこへの通信を制御したり監視したりできる。
* インターネットに接続できるサーバーだけを別サブネットに分け、社内LANから隔離する。


# トラブルシューティング
どこまで繋がっていて、どこから繋がっていないのか、順番に探っていく。
各操作（コマンド）の結果、何が言えるのか理解する。

インターネットに繋がるか。
他のブラウザで繋がるか。
物理的に繋がっているか。（ケーブルを変えたり、接続先を変えたり）
LAN内（他端末や共有フォルダなど）と通信できるか。
default gateway や DNSサーバー と疎通できるか。
名前解決できるか。

ipconfig
ipアドレスが割り振られているかを確認。DHCPが関連する。
default gateway や DNSサーバー のアドレスを確認する。

ping
default gateway や DNSサーバー と疎通確認を行う。
LAN内の他の端末との疎通確認を行う。

tracert
www.google.comなどに繋げてどこまで繋がるか確認する。
名前解決できるか確認する。

